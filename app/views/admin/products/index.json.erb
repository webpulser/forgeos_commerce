<%
  is_selection = params[:mode] == 'selection'
  output = {
    :sEcho => params[:sEcho],
    :iTotalRecords => @products.total_entries || 0,
    :iTotalDisplayRecords => @products.size,
    :aaData => @products.collect do |product|

      picture = product.pictures.first.public_filename(:thumb) if product.pictures.first
      klass = product.active? ? 'see-on' : 'see-off'

      product_array = []

      if params[:mode] && params[:mode].eql?('menu_link')
        product_array <<
        content_tag(:div, content_tag(:div, '', :class=>'handler') + image_tag(picture || 'forgeos/admin/no-image.png'), :id => polymorphic_html_id(product), :class => 'one-product handler_container')
        product_array << content_tag(:div, product.name, :class => 'product-name')
        product_array << product.id
        product_array << link_to(product.name, [forgeos_commerce, :edit, :admin, product])

      else
        if product.kind_of?(Pack) && !is_selection

          product_array <<
          content_tag(:div, content_tag(:div, content_tag(:div, '', :class => 'handler') + image_tag(picture || 'forgeos/admin/no-image.png'), :class=>'image'), :id => polymorphic_html_id(product), :class => 'some-variants plus handler_container') <<
          content_tag(:div, link_to(product.name, [forgeos_commerce, :edit, :admin, product]) + content_tag(:span, product.products.count), :class => 'product-name') +
          content_tag(:p, product.products.collect { |variant| content_tag(:span,variant.name, :class => cycle('even','odd')) }, :class=>'product-name')
          product_array <<
          content_tag(:div, price_with_currency(product.price), :class => 'price') +
          content_tag(:p, product.products.collect{ |p| price_with_currency(p.price)}.join('<br />')) <<
          content_tag(:div, product.stock, :class => 'stocks' ) + '<br /><p class="stocks">' + product.products.collect(&:stock).join('<br />') + '</p>'

        else

          product_array <<
            content_tag(:div, content_tag(:div, '', :class => 'handler') + image_tag(picture || 'forgeos/admin/no-image.png'), :id => polymorphic_html_id(product), :class => 'one-product handler_container') <<
            content_tag(:div, is_selection ? product.name : link_to(product.name, [forgeos_commerce, :edit, :admin, product]), :class => 'product-name')
          product_array << content_tag(:div, product.sku) if is_selection
          product_array <<
            content_tag(:div, price_with_currency(product.price), :class => 'price') <<
            content_tag(:div, product.stock, :class => 'stocks' )

        end

        product_array <<
          (product.product_type.name || ' ')<<
            link_to('', [forgeos_commerce, :activate, :admin, product],
              :remote => true,
              :class => "small-icons #{klass}",
              :id => polymorphic_html_id(product, 'show')
            ) <<
              link_to('', [forgeos_commerce, :duplicate, :admin, product], :class => 'small-icons duplicate-link') +
              link_to('', [forgeos_commerce, :edit, :admin, product], :class => 'small-icons edit-link') +
              link_to('', [forgeos_commerce, :admin, product],
                :remote => true,
                :method => :delete,
                :confirm => (product.redirection_product ? t('product.destroy.redirection_product.confirm', :product => product.redirection_product.sku) : t('product.destroy.redirection_product.none')),
                :class => 'small-icons destroy-link',
                :id => polymorphic_html_id(product, 'destroy')
              ) << product.id << (product.name or '') << product.sku << product.price
      end
    end
  }
-%>
<%= raw output.to_json -%>
